(function(d){function e(s){if(d(s).data("treegrid")){return"treegrid"}else{return"datagrid"}}var o=d.fn.datagrid.methods.autoSizeColumn;d.fn.datagrid.methods.autoSizeColumn=function(t,s){return t.each(function(){p(this,s,10);o.call(d.fn.datagrid.methods,d(this),s);p(this,s)})};var j=d.fn.datagrid.methods.loadData;d.fn.datagrid.methods.loadData=function(t,s){t.each(function(){d.data(this,"datagrid").filterSource=null});return j.call(d.fn.datagrid.methods,t,s)};var g=d.fn.treegrid.methods.loadData;d.fn.treegrid.methods.loadData=function(t,s){t.each(function(){d.data(this,"treegrid").filterSource=null});return g.call(d.fn.treegrid.methods,t,s)};var b=d.fn.datagrid.methods.appendRow;d.fn.datagrid.methods.appendRow=function(u,t){var s=b.call(d.fn.datagrid.methods,u,t);u.each(function(){var v=d(this).data("datagrid");if(v.filterSource){v.filterSource.total++;v.filterSource.rows.push(t)}});return s};var a=d.fn.treegrid.methods.append;d.fn.treegrid.methods.append=function(u,t){var s=a.call(d.fn.treegrid.methods,u,t);u.each(function(){});return s};var m=d.fn.datagrid.methods.deleteRow;d.fn.datagrid.methods.deleteRow=function(t,s){t.each(function(){var w=d(this).data("datagrid");var v=w.options;if(w.filterSource&&v.idField){for(var u=0;u<w.filterSource.rows.length;u++){var x=w.filterSource.rows[u];if(x[v.idField]==w.data.rows[s][v.idField]){w.filterSource.rows.splice(u,1);w.filterSource.total--;break}}}});return m.call(d.fn.datagrid.methods,t,s)};var q={filterMenuIconCls:"icon-ok",filterBtnIconCls:"icon-filter",filterBtnPosition:"right",filterPosition:"bottom",remoteFilter:false,filterDelay:400,filterRules:[],filterMatcher:function(y){var u=e(this);var t=d.data(this,u);var s=t.options;if(s.filterRules.length){var C=[];if(u=="treegrid"){var x={};d.map(y.rows,function(D){if(w(D)){x[D[s.idField]]=D;D=A(y.rows,D._parentId);while(D){x[D[s.idField]]=D;D=A(y.rows,D._parentId)}}});for(var v in x){C.push(x[v])}}else{for(var z=0;z<y.rows.length;z++){var B=y.rows[z];if(w(B)){C.push(B)}}}y={total:y.total-(y.rows.length-C.length),rows:C}}return y;function w(H){var G=s.filterRules;for(var D=0;D<G.length;D++){var F=G[D];var E=H[F.field];if(E==undefined){E=""}var I=s.operators[F.op];if(!I.isMatch(E,F.value)){return false}}return true}function A(E,G){for(var D=0;D<E.length;D++){var F=E[D];if(F[s.idField]==G){return F}}return null}},defaultFilterType:"text",defaultFilterOperator:"contains",defaultFilterOptions:{onInit:function(w){var t=e(w);var v=d(w)[t]("options");var s=d(this);s.unbind(".filter").bind("keydown.filter",function(y){var x=d(this);if(this.timer){clearTimeout(this.timer)}if(y.keyCode==13){u()}else{this.timer=setTimeout(function(){u()},v.filterDelay)}});function u(){var z=s.attr("name");var y=d(w)[t]("getFilterRule",z);var x=s.val();if(x!=""){if((y&&y.value!=x)||!y){d(w)[t]("addFilterRule",{field:z,op:v.defaultFilterOperator,value:x});d(w)[t]("doFilter")}}else{if(y){d(w)[t]("removeFilterRule",z);d(w)[t]("doFilter")}}}}},filterStringify:function(s){return JSON.stringify(s)},onClickMenu:function(t,s){}};d.extend(d.fn.datagrid.defaults,q);d.extend(d.fn.treegrid.defaults,q);d.fn.datagrid.defaults.filters=d.extend({},d.fn.datagrid.defaults.editors,{label:{init:function(s,t){return d("<span></span>").appendTo(s)},getValue:function(s){return d(s).html()},setValue:function(t,s){d(t).html(s)},resize:function(t,s){d(t)._outerWidth(s)._outerHeight(22)}}});d.fn.treegrid.defaults.filters=d.fn.datagrid.defaults.filters;d.fn.datagrid.defaults.operators={nofilter:{text:"取消过滤"},contains:{text:"包含",isMatch:function(t,s){t=String(t);s=String(s);return t.toLowerCase().indexOf(s.toLowerCase())>=0}},equal:{text:"等于",isMatch:function(t,s){return t==s}},notequal:{text:"不等于",isMatch:function(t,s){return t!=s}},beginwith:{text:"起始匹配",isMatch:function(t,s){t=String(t);s=String(s);return t.toLowerCase().indexOf(s.toLowerCase())==0}},endwith:{text:"结尾匹配",isMatch:function(t,s){t=String(t);s=String(s);return t.toLowerCase().indexOf(s.toLowerCase(),t.length-s.length)!==-1}},less:{text:"小于",isMatch:function(t,s){return t<s}},lessorequal:{text:"小于 或 等于",isMatch:function(t,s){return t<=s}},greater:{text:"大于",isMatch:function(t,s){return t>s}},greaterorequal:{text:"大于 或 等于",isMatch:function(t,s){return t>=s}}};d.fn.treegrid.defaults.operators=d.fn.datagrid.defaults.operators;function p(w,v,t){var u=d(w);var x=u.datagrid("getPanel").find("div.datagrid-header");var s=v?x.find('.datagrid-filter[name="'+v+'"]'):x.find(".datagrid-filter");s.each(function(){var z=d(this).attr("name");var y=u.datagrid("getColumnOption",z);var B=d(this).closest("div.datagrid-filter-c");var A=B.find("a.datagrid-filter-btn");if(t!=undefined){this.filter.resize(this,t)}else{this.filter.resize(this,10);this.filter.resize(this,B.width()-A._outerWidth())}})}function l(t,s){var u=d(t).datagrid("getPanel").find("div.datagrid-header");return u.find('tr.datagrid-filter-row td[field="'+s+'"] .datagrid-filter')}function r(v,u){var s=e(v);var w=d(v)[s]("options").filterRules;for(var t=0;t<w.length;t++){if(w[t].field==u){return t}}return -1}function i(v,u){var t=e(v);var w=d(v)[t]("options").filterRules;var s=r(v,u);if(s>=0){return w[s]}else{return null}}function f(x,v){var t=e(x);var s=d(x)[t]("options");var z=s.filterRules;if(v.op=="nofilter"){c(x,v.field)}else{var w=r(x,v.field);if(w>=0){d.extend(z[w],v)}else{z.push(v)}}var y=l(x,v.field);if(y.length){if(v.op!="nofilter"){y[0].filter.setValue(y,v.value)}var u=y[0].menu;if(u){u.find("."+s.filterMenuIconCls).removeClass(s.filterMenuIconCls);var A=u.menu("findItem",s.operators[v.op]["text"]);u.menu("setIcon",{target:A.target,iconCls:s.filterMenuIconCls})}}}function c(z,y){var u=e(z);var x=d(z);var w=x[u]("options");if(y){var t=r(z,y);if(t>=0){w.filterRules.splice(t,1)}v([y])}else{w.filterRules=[];var s=x.datagrid("getColumnFields",true).concat(x.datagrid("getColumnFields"));v(s)}function v(A){for(var C=0;C<A.length;C++){var B=l(z,A[C]);if(B.length){B[0].filter.setValue(B,"");var D=B[0].menu;if(D){D.find("."+w.filterMenuIconCls).removeClass(w.filterMenuIconCls)}}}}}function h(v){var s=e(v);var u=d.data(v,s);var t=u.options;if(t.remoteFilter){d(v)[s]("load")}else{d(v)[s]("getPager").pagination("refresh",{pageNumber:1});d(v)[s]("options").pageNumber=1;d(v)[s]("loadData",u.filterSource||u.data)}}function k(z,A){var u=e(this);var t=d.data(this,u);var s=t.options;if(u=="datagrid"&&d.isArray(z)){z={total:z.length,rows:z}}else{if(u=="treegrid"&&d.isArray(z)){function x(H,G){if(!H||!H.length){return[]}var I=[];d.map(H,function(J){J._parentId=G;I.push(J);I=I.concat(x(J.children,J[s.idField]))});return I}var F=x(z,A);d.map(F,function(G){G.children=undefined});z={total:F.length,rows:F}}}if(!s.remoteFilter){if(!t.filterSource){t.filterSource=z}else{if(u=="datagrid"&&!s.isSorting){t.filterSource=z}else{if(u=="treegrid"&&!s.isSorting){var E=d.extend(true,[],z.rows);t.filterSource.total+=E.length;t.filterSource.rows=t.filterSource.rows.concat(E)}}s.isSorting=undefined}z=s.filterMatcher.call(this,{total:t.filterSource.total,rows:d.extend(true,[],t.filterSource.rows)});if(s.pagination){var C=d(this);var w=C[u]("getPager");w.pagination({onSelectPage:function(H,G){s.pageNumber=H;s.pageSize=G;w.pagination("refresh",{pageNumber:H,pageSize:G});C[u]("loadData",t.filterSource)},onBeforeRefresh:function(){C[u]("reload");return false}});if(u=="datagrid"){var v=(s.pageNumber-1)*parseInt(s.pageSize);var y=v+parseInt(s.pageSize);z.rows=z.rows.slice(v,y)}else{var B=[];var D=[];d.map(z.rows,function(G){G._parentId?D.push(G):B.push(G)});z.total=B.length;var v=(s.pageNumber-1)*parseInt(s.pageSize);var y=v+parseInt(s.pageSize);z.rows=d.extend(true,[],B.slice(v,y).concat(D))}}}return z}function n(E,A){A=A||[];var w=e(E);var v=d.data(E,w);var s=v.options;if(!s.filterRules.length){s.filterRules=[]}var H=s.onResizeColumn;s.onResizeColumn=function(J,I){if(s.fitColumns){p(E,null,10);d(E).datagrid("fitColumns");p(E)}else{p(E,J)}H.call(E,J,I)};var t=s.onResize;s.onResize=function(J,I){p(E,null,10);d(E).datagrid("fitColumns");p(E);t.call(this,J,I)};var D=s.onBeforeLoad;s.onBeforeLoad=function(K,J){if(K){K.filterRules=s.filterStringify(s.filterRules)}if(J){J.filterRules=s.filterStringify(s.filterRules)}var I=D.call(this,K,J);if(I!=false&&s.url){v.filterSource=null}return I};var z=d.data(E,"datagrid").options;var y=z.onBeforeSortColumn;z.onBeforeSortColumn=function(K,J){var I=y.call(this,K,J);if(I!=false){s.isSorting=true}return I};var C=s.onBeforeEdit;s.onBeforeEdit=function(J,K){var I=C.call(this,J,K);v.originalEditingRow=d.extend(true,{},w=="treegrid"?J:K);return I};var x=s.onAfterEdit;s.onAfterEdit=function(I,M,K){if(s.idField&&v.filterSource){for(var J=0;J<v.filterSource.rows.length;J++){var L=v.filterSource.rows[J];if(L[s.idField]==v.originalEditingRow[s.idField]){d.extend(L,w=="treegrid"?I:M);break}}}x.call(this,I,M,K)};s.loadFilter=function(I,K){var J=s.oldLoadFilter.call(this,I,K);return k.call(this,J,K)};G();B(true);B();if(s.fitColumns){setTimeout(function(){p(E)},0)}d.map(s.filterRules,function(I){f(E,I)});function G(){if(!d("#datagrid-filter-style").length){d("head").append('<style id="datagrid-filter-style">a.datagrid-filter-btn{display:inline-block;width:22px;height:22px;margin:0;vertical-align:top;cursor:pointer;opacity:0.6;filter:alpha(opacity=60);}a:hover.datagrid-filter-btn{opacity:1;filter:alpha(opacity=100);}.datagrid-filter-row .textbox,.datagrid-filter-row .textbox .textbox-text{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-row input{margin:0;-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}</style>')}}function B(I){var T=v.dc;var P=d(E).datagrid("getColumnFields",I);if(I&&s.rownumbers){P.unshift("_")}var U=(I?T.header1:T.header2).find("table.datagrid-htable");U.find(".datagrid-filter").each(function(){if(this.filter.destroy){this.filter.destroy(this)}if(this.menu){d(this.menu).menu("destroy")}});U.find("tr.datagrid-filter-row").remove();var Q=d('<tr class="datagrid-header-row datagrid-filter-row"></tr>');if(s.filterPosition=="bottom"){Q.appendTo(U.find("tbody"))}else{Q.prependTo(U.find("tbody"))}for(var O=0;O<P.length;O++){var S=P[O];var M=d(E).datagrid("getColumnOption",S);if(M&&(M.checkbox||M.expander)){S="_"}var N=d("<td></td>").attr("field",S).appendTo(Q);if(M&&M.hidden){N.hide()}if(S=="_"){continue}var J=d('<div class="datagrid-filter-c"></div>').appendTo(N);var L=F(S);if(!L){L=d.extend({},{field:S,type:s.defaultFilterType,options:s.defaultFilterOptions})}var K=s.filters[L.type];var R=K.init(J,L.options||{});R.addClass("datagrid-filter").attr("name",S);R[0].filter=K;R[0].menu=u(J,L.op);if(L.options&&L.options.onInit){L.options.onInit.call(R[0],E)}p(E,S)}}function u(J,I){if(!I){return null}var K=d('<a class="datagrid-filter-btn">&nbsp;</a>').addClass(s.filterBtnIconCls);if(s.filterBtnPosition=="right"){K.appendTo(J)}else{K.prependTo(J)}var L=d("<div></div>").appendTo("body");L.menu({alignTo:K,onClick:function(O){var N=d(this).menu("options").alignTo;var R=N.closest("td[field]");var Q=R.attr("field");var M=R.find(".datagrid-filter");var P=M[0].filter.getValue(M);f(E,{field:Q,op:O.name,value:P});s.onClickMenu.call(E,O,N);h(E)}});d.each(["nofilter"].concat(I),function(M,N){var O=s.operators[N];if(O){L.menu("appendItem",{text:O.text,name:N})}});K[0].menu=L;K.bind("click",{menu:L},function(M){d(this.menu).menu("show");return false});return L}function F(K){for(var I=0;I<A.length;I++){var J=A[I];if(J.field==K){return J}}return null}}d.extend(d.fn.datagrid.methods,{enableFilter:function(t,s){return t.each(function(){var u=e(this);var v=d.data(this,u).options;v.oldLoadFilter=v.loadFilter;n(this,s);d(this)[u]("resize");if(v.filterRules.length){h(this)}})},disableFilter:function(s){return s.each(function(){var v=e(this);var w=d.data(this,v).options;var u=d(this).data("datagrid").dc;var t=u.header1.add(u.header2).find(".datagrid-filter-row");t.find(".datagrid-filter-btn").each(function(){d(this.menu).menu("destroy")});t.find(".combo-f").each(function(){d(this).combo("destroy")});d(this)[v]({loadFilter:(w.oldLoadFilter||undefined),oldLoadFilter:null})})},getFilterRule:function(t,s){return i(t[0],s)},addFilterRule:function(t,s){return t.each(function(){f(this,s)})},removeFilterRule:function(t,s){return t.each(function(){c(this,s)})},doFilter:function(s){return s.each(function(){h(this)})},getFilterComponent:function(t,s){return l(t[0],s)}})})(jQuery);