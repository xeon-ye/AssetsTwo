var defQury=(function(m){var b=m,n={},k=0,h=1,c=2,i=3,l={},j={},g=[{id:1,text:"并且",state:"open",iconCls:"icon-edit",children:[],attributes:{type:k},_pid:-1}],e,a={},f,d={};_selectors={},_p={},_selectNode={},_edit=false,_openRule=function(){var r=_selectNode,p=f;if(r.attributes.type===c||r.attributes.type===i){return true}b("#ruleName").text(r.text);if(p){b("#d_"+p).css("display","none")}p=f=r.dataType;b("#d_"+p).css("display","block");if(p==="dict"){var q=r.attributes.dictCode;if(d[q]){b("#d_dict_v").combobox("loadData",d[q]).combobox("setText","")}else{Platform6.fn.lookup.getLookupType(q,function(s){d[q]=s;b("#d_dict_v").combobox("loadData",s).combobox("setText","")},true)}_edit&&a.combobox("select","eq")}else{if(p==="role"){if(!_selectors[p]){var o=new CommonSelector("role","roleSelectCommonDialog","roleId","roleName",null,null,null);o.init();_selectors[p]=true}_edit&&a.combobox("select","eq")}else{if(p==="dept"){if(!_selectors[p]){var o=new CommonSelector("dept","roleSelectCommonDialog","deptId","deptName",null,null,null);o.init();_selectors[p]=true}_edit&&a.combobox("select","eq")}else{if(p==="user"){if(!_selectors[p]){var o=new CommonSelector("user","roleSelectCommonDialog","userId","userName",null,null,null);o.init();_selectors[p]=true}_edit&&a.combobox("select","eq")}else{if(p==="group"){if(!_selectors[p]){var o=new CommonSelector("group","roleSelectCommonDialog","groupId","groupName",null,null,null);o.init();_selectors[p]=true}_edit&&a.combobox("select","eq")}else{if(p==="post"){if(!_selectors[p]){var o=new CommonSelector("position","roleSelectCommonDialog","postId","postName",null,null,null);o.init();_selectors[p]=true}_edit&&a.combobox("select","eq")}}}}}}j.dialog("open",true)},_f=function(s){s.preventDefault();if(_selectNode.id===1){_tip("不能添加平级条件");return false}var q=_selectNode,r,u=n.datagrid("getSelected"),v,p=l,o;if(q.attributes.type===c&&u.type===c){_tip("不能添加【或者】");return false}v=_guid();r=p.tree("find",q._pid);if(u.type===h){o=' <span class="dnf-red"> 包含</span>'}p.tree("append",{parent:r.target,data:[{id:v,text:u.name,state:"open",iconCls:"icon-search",children:[],attributes:{type:u.type,dictCode:u.dictCode},_pid:r.id,myk:u.field,dataType:u.dataType,alias:o,ruleOpt:"like"}]}).tree("select",p.tree("find",v).target);_edit=true;_openRule();return true},_f2=function(s){s.preventDefault();if(!_selectNode){_tip("请选择一个节点！")}var q=_selectNode,r=q.target,u=n.datagrid("getSelected"),v,p,o=l;if(q.attributes.type===k&&q.children.length===0&&u.type===c){_tip("根下面不能直接添加【或者】");return false}else{if(q.attributes.type===h){_tip("条件下面不能添加条件");return false}else{if(q.attributes.type===i&&q.children.length===0&&u.type===c){_tip("分组下面不能直接添加【或者】");return false}else{if(q.attributes.type===c){_tip("【或者】下面不能添加条件");return false}}}}v=_guid();if(u.type===h){p=' <span class="dnf-red"> 包含</span>'}o.tree("append",{parent:r,data:[{id:v,text:u.name,state:"open",iconCls:"icon-search",children:[],attributes:{type:u.type,dictCode:u.dictCode},_pid:q.id,myk:u.field,dataType:u.dataType,alias:p,ruleOpt:"like"}]}).tree("select",o.tree("find",v).target);_edit=true;_openRule();return true},_f3=function(r){r.preventDefault();var o,p=_selectNode,q;if(p.id===1){_tip("不能删除根节点!");return false}o=l.tree("remove",p.target);q=o.tree("find",p._pid).children;if(q.length>0){l.tree("select",q[0].target)}else{l.tree("select",l.tree("find",p._pid).target)}_cal();return true},_query=function(){var o=b.extend({},e);o.target={};_rmTarget(o.children);l.tree('select',l.tree('find',_selectNode.id).target);_p.getQuery()({sdfConditons:JSON.stringify(o)})},_rmTarget=function(p){var q=p.length,o;for(;q--;){o=p[q];o.target={};if(o.children.length>0){_rmTarget(o.children)}}},_ensure=function(u){u.preventDefault();var q=b,w,r,v=q("#ruleOpt"),p=v.combobox("getValue"),o=v.combobox("getText"),s,x=l;if(f==="string"){r=w=q("#d_string_v").val()}else{if(f==="date"){r=q("#d_date_v").datebox("getValue");w=new Date(r.replace("-","/").replace("-","/")+" 00:00:00").getTime()}else{if(f==="datetime"){r=q("#d_datetime_v").datetimebox("getValue");w=new Date(r.replace("-","/").replace("-","/")).getTime()}else{if(f==="dict"){w=q("#d_dict_v").combobox("getValue");if(w){r=q("#d_dict_v").combobox("getText")}else{r=""}}else{if(f==="number"){r=w=q("#d_number_v").numberbox("getValue")}else{if(f==="role"){w=q("#roleId").val();if(w){r=q("#roleName").val()}else{r=""}}else{if(f==="dept"){w=q("#deptId").val();if(w){r=q("#deptName").val()}else{r=""}}else{if(f==="user"){w=q("#userId").val();if(w){r=q("#userName").val()}else{r=""}}else{if(f==="group"){w=q("#groupId").val();if(w){r=q("#groupName").val()}else{r=""}}else{if(f==="post"){w=q("#postId").val();if(w){r=q("#postName").val()}else{r=""}}}}}}}}}}}if(p){s=' <span class="dnf-red"> '+o+'</span><span class="dnf-blue"> 【'+r+"】</span>"}x.tree("update",{target:_selectNode.target,ruleOpt:p,ruleName:o,textValue:w,alias:s});j.dialog("close",true);_cal();x.tree("select",x.tree("find",_selectNode._pid).target)},_cancel=function(o){o.preventDefault();if(_edit){b("#del").click()}j.dialog("close",true)},_treeClc=function(o){_selectNode=o},_treeDclc=function(o){if(o.attributes.type===k){return false}_edit=false;_selectNode=o;_openRule();if(o.ruleOpt){a.combobox("setValue",o.ruleOpt)}if(o.textValue){if(f==="string"){b("#d_string_v").val(o.textValue)}else{if(f==="date"){b("#d_date_v").datebox("setValue",new Date(o.textValue).format("yyyy-MM-dd"))}else{if(f==="datetime"){b("#d_datetime_v").datetimebox("setValue",Date(o.textValue).format("yyyy-MM-dd HH:mm:ss"))}else{if(f==="dict"){b("#d_dict_v").combobox("setValue",o.textValue)}else{if(f==="dict"){b("#d_number_v").numberbox("setValue",o.textValue)}}}}}}},_treefmt=function(p){var o=p.text;if(p.alias){return o+p.alias}else{return o}},_tip=function(o){b.messager.show({title:"提示",msg:o})},_parse=function(s){var v="",q=' <span class="dnf-green">并且</span> ',t=' <span class="dnf-green">或者</span> ',r=0,u=s.length,p;var o="";for(;r<u;r++){p=s[r];if(p.attributes.type===i&&p.children.length>0){o+=v+"（"+_parse(p.children)+"）";v=q}else{if(p.attributes.type===h&&p.ruleOpt){o+=v+p.text+p.alias;v=q}else{if(p.attributes.type===c){v=t}}}}return o},_cal=function(){var o=_parse(e.children);b("#myParser").html('<div style="font-size:15px;">&nbsp;'+o+"</div>")},_guid=function(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4())},S4=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)};return{init:function(o){var p;_p=o;n=b("#selfDefGrid").datagrid({url:null});p=l=b("#selfDefTree").tree({url:null,data:g,onSelect:_treeClc,onDblClick:_treeDclc,formatter:_treefmt});j=b("#selfDefRule").css('display','block').dialog({title:"查询条件设置"}).dialog("close",true);e=p.tree("find",1);p.tree("select",e.target);b("#add1").bind("click",_f2);b("#del").bind("click",_f3);b("#query").bind("click",_query);b("#ruleBtns_ensure").bind("click",_ensure);b("#ruleBtns_cancel").bind("click",_cancel);a=b("#ruleOpt").combobox("loadData",[{key:"like",value:"包含"},{key:"eq",value:"等于"},{key:"gt",value:"大于"},{key:"gteq",value:"大于等于"},{key:"lt",value:"小于"},{key:"lteq",value:"小于等于"},{key:"uneq",value:"不等于"}]).combobox("select","like");return this.loadGrid(o.getFields())},show:function(){this._iDg=new CommonDialog("insert","700","400","static/js/platform/component/sfn/SelfDefiningQuery.jsp","添加菜单",false,true,false);this._iDg.show()},loadGrid:function(o){n.datagrid("loadData",o).datagrid("selectRow",0);return this}}}($));