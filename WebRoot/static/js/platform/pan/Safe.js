$(document).bind("contextmenu",function(){return false;});var Safe=(function(g){var r={},c=false,C=0,o=0,i=function(){g("#"+r.modify).linkbutton("enable").unbind("click").bind("click",function(){var G,F,H,I;if(c){$dategrid.datagrid("scrollTo",C);G=$dategrid.datagrid("getEditor",{index:C,field:"fsName"});F=g(G.target).focus().select();return}I=$dategrid.datagrid("getChecked")[0];if(!I){return}H=$dategrid.datagrid("getRowIndex",I);G=$dategrid.datagrid("beginEdit",H).datagrid("getEditor",{index:H,field:"fsName"});C=H;o=2;F=g(G.target).css("vertical-align","middle");B(F,H,I);c=true})},f=function(){g("#"+r.del).linkbutton("enable").unbind("click").bind("click",function(){var H=$dategrid.datagrid("getChecked"),G=[],F=H.length;if(F){g.messager.confirm("请确认","您确定要永久性地删除当前所选的数据吗？",function(I){if(I){for(;F--;){G.push(H[F].id)}g.messager.progress();g.ajax({url:"platform/span/safe/delete.json",type:"post",data:{ids:JSON.stringify(G)},dataType:"json",success:function(J){g.messager.progress("close");if(J&&J.errno==0){g.messager.show({title:"提示",msg:"删除成功！"});b();if(parent&&parent.nav){parent.nav.loadSize().needReycble()}}else{if(J&&J.errno==6){u(J)}else{g.messager.show({title:"提示",msg:J.msg})}}}})}})}else{g.messager.alert("提示","请选择要删除的记录！","warning")}})},m=function(){g("#"+r.down).linkbutton("enable").unbind("click").bind("click",function(){var G=$dategrid.datagrid("getChecked"),I=[],F=G.length;for(;F--;){I.push({key:G[F].id,value:G[F].ownerId})}var H="platform/span/safe/down?objs="+JSON.stringify(I);new DownLoad4URL("iframe","form",null,H).downLoad()})},q=function(){g("#"+r.down).linkbutton("disable").unbind("click");g("#"+r.modify).linkbutton("disable").unbind("click");if($dategrid.datagrid("getChecked").length===0){g("#"+r.save).linkbutton("disable").unbind("click");g("#"+r.del).linkbutton("disable").unbind("click")}else{h();f()}},A=function(){var F=$dategrid.datagrid("getChecked");if(F.length===1){i();h();f();if(F[0].isdir=="1"){m()}}else{if(F.length===0){g("#"+r.save).linkbutton("disable").unbind("click");g("#"+r.del).linkbutton("disable").unbind("click")}else{g("#"+r.modify).linkbutton("disable").unbind("click");g("#"+r.down).linkbutton("disable").unbind("click")}}},u=function(F){if(parent&&parent.nav){parent.nav.onClickSafe()}else{window.location.href=F.url}},w="-1",y=[],E,e=false,l=true,j=1,D=function(G,F){(function(I){var H=g('<span class="sure"></span>'),J=g('<span class="cancel"></span>');G.css("width",G.width()-58).after(J).after(H).bind("keydown",function(K){if(K.keyCode==13){K.preventDefault();K.stopPropagation();x(0)}else{if(K.keyCode==27){$dategrid.datagrid("deleteRow",I);c=false;return false}}});H.bind("click",function(){x(I)});J.bind("click",function(){$dategrid.datagrid("deleteRow",I);c=false})})(F)},B=function(H,G,J){var F=g('<span class="sure"></span>'),I=g('<span class="cancel"></span>');(function(K,L){H.css("width",H.width()-58).after(I).after(F).bind("keydown",function(M){if(M.keyCode==13){M.preventDefault();M.stopPropagation();t(K,L)}else{if(M.keyCode==27){$dategrid.datagrid("cancelEdit",K).datagrid("uncheckRow",K);c=false;return false}}});F.bind("click",function(){t(K,L)});I.bind("click",function(){$dategrid.datagrid("cancelEdit",K).datagrid("uncheckRow",K);c=false})})(G,J)},x=function(F){var G=g($dategrid.datagrid("getEditor",{index:0,field:"fsName"}).target).val();if(k(G)){return}G=v(G);g.messager.progress();g.ajax({url:"platform/span/safe/create.json",type:"post",data:{text:G,parent:w},dataType:"json",success:function(J){g.messager.progress("close");if(J&&J.errno==0){$dategrid.datagrid("updateRow",{index:F,row:{id:J.fid,fsName:J.name,svrMtime:J.svrMtime}});c=false;var H=g("#navTips").text(),I=H.indexOf("已加载全部");if(I!==0){g("#navTips").text("已加载"+(parseInt(H.slice(3,H.length-1))+1)+"个")}else{g("#navTips").text("已加载全部,共"+(parseInt(H.slice(7,H.length-1))+1)+"个")}}else{if(J&&J.errno==6){u(J)}else{g.messager.show({title:"创建文件夹失败！",msg:J.msg})}}}})},t=function(F,G){var H=g($dategrid.datagrid("getEditor",{index:F,field:"fsName"}).target).val();if(H===G.fsName){$dategrid.datagrid("cancelEdit",F).datagrid("uncheckRow",F);c=false;return false}if(k(H)){return false}H=v(H);g.messager.progress();g.ajax({url:"platform/span/safe/rename.json",type:"post",data:{text:H,id:G.id,type:G.isdir},dataType:"json",success:function(I){g.messager.progress("close");if(I&&I.errno==0){$dategrid.datagrid("updateRow",{index:F,row:{fsName:I.name,svrMtime:I.svrMtime,fsMime:I.extName}}).datagrid("uncheckRow",F);c=false}else{if(I&&I.errno==6){u(I)}else{g.messager.show({title:"重命名失败！",msg:I.msg})}}}})},k=function(F){if(!F){alert("文件夹名称不能为空");return true}if((/[\\/\:\?\"<>\*]+/).test(F)){alert("文件名不能包含以下字符：<,>,|,*,?,,/");return true}return false},v=function(F){return F.replace(/^\s*|\s*$/g,"")},n=function(F,G){w=F||w;j=1;g.messager.progress();g.ajax({url:"platform/span/safe/getSpanAllItem.json",type:"get",data:{page:r.page,rows:r.rows,parentId:w},dataType:"json",success:function(H){g.messager.progress("close");if(H&&H.errno==0){$dategrid.datagrid("loadData",H.rows).datagrid("clearChecked");y.push({id:w,text:G});if(w!=="-1"){z()}else{s()}if(H.total>r.page*r.rows){g("#navTips").text("已加载"+r.page*r.rows+"个");l=false}else{g("#navTips").text("已加载全部,共"+H.total+"个");l=true}}else{if(H&&H.errno==6){u(H)}else{g.messager.show({title:"加载失败！",msg:H.msg})}}}});return this},b=function(F,G){w=F||w;g.messager.progress();j=1;g.ajax({url:"platform/span/safe/getSpanAllItem.json",type:"get",data:{page:r.page,rows:r.rows,parentId:w},dataType:"json",success:function(H){g.messager.progress("close");if(H&&H.errno==0){$dategrid.datagrid("loadData",H.rows).datagrid("clearChecked");if(w!=="-1"){z()}else{s()}if(H.total>r.page*r.rows){g("#navTips").text("已加载"+r.page*r.rows+"个");l=false}else{g("#navTips").text("已加载全部,共"+H.total+"个");l=true}}else{if(H&&H.errno==6){u(H)}else{g.messager.show({title:"加载失败！",msg:H.msg})}}}});return this},a=function(F){e=true;if(c){if(o===1){$dategrid.datagrid("deleteRow",C)}else{if(o===2){$dategrid.datagrid("cancelEdit",C).datagrid("uncheckRow",C)}}c=false}g.messager.progress();g.ajax({url:"platform/span/safe/getSpanAllItem.json",type:"get",data:{page:F,rows:r.rows,parentId:w},dataType:"json",success:function(I){g.messager.progress("close");if(I&&I.errno==0){var G=$dategrid.datagrid("getRows");var H=I.rows.length;for(;H--;){G.push(I.rows.shift())}if(I.total>F*r.rows){g("#navTips").text("已加载"+F*r.rows+"个");l=false}else{g("#navTips").text("已加载全部,共"+I.total+"个");l=true}$dategrid.datagrid("loadData",G).datagrid("clearChecked")}else{if(I&&I.errno==6){u(I)}else{g.messager.show({title:"加载失败！",msg:I.msg})}}e=false}});return this},z=function(){var H=y.length,F=0;var G=g("#hisContent");G.empty();g('<a href="javastript:void(0);" title="返回上一级">返回上一级</a>').bind("click",function(){y.pop();b(y[y.length-1].id);return false}).appendTo(G);g("<span>|</span>").appendTo(G);g('<a href="javastript:void(0);" title="全部文件">全部文件</a>').bind("click",function(){y=[];n("-1");return false}).appendTo(G);g("<span>&gt;</span>").appendTo(G);for(;F<H;F++){if(y[F].id==="-1"){}else{if(F===H-1){g("<span>"+y[F].text+"</span>").appendTo(G)}else{(function(I){g('<a href="javastript:void(0);" title="'+y[I].text+'">'+y[I].text+"</a>").bind("click",function(){var J=y[I].id;var L=[];for(var K=0;K<y.length;K++){L.push(y[K]);if(y[K].id==J){break}}y=L;b(J);return false}).appendTo(G);g("<span>&gt;</span>").appendTo(G)})(F)}}}},s=function(){var F=g("#hisContent");F.empty();g("<span>全部文件</span>").appendTo(F)},p=function(I){var G=$dategrid.datagrid("getChecked"),H=[],F=G.length;for(;F--;){H.push({key:G[F].id,value:G[F].fsName})}g.messager.progress();g.ajax({url:"platform/span/safe/transfer2my/"+I.id+".json",type:"post",data:{objs:JSON.stringify(H)},dataType:"json",success:function(J){g.messager.progress("close");if(J&&J.errno==0){g.messager.show({title:"提示",msg:"成功转出！"});b()}else{if(J&&J.errno==6){u(J)}else{g.messager.show({title:"提示",msg:J.msg})}}}})},h=function(){g("#"+r.save).linkbutton("enable").unbind("click").bind("click",function(){dirTree.show("移动到");dirTree.setOkBack(p)})};var d=function(F){r=g.extend({},{page:1,rows:100,count:100},F);if(r.grid){$dategrid=g("#"+r.grid).datagrid({url:null,onCheck:A,onUncheck:A,onCheckAll:q,onUncheckAll:q});$prev=$dategrid.prev().find(".datagrid-body").scroll(function(J){J.preventDefault();J.stopPropagation();if(l){return false}var G=g(this).height(),H=g(this).get(0).scrollHeight,I=g(this).scrollTop();if(I/(H-G)>=0.98){if(!e){j++;a(j)}}})}if(r.toolBar){E=g('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><div id="hisContent"></div></div>');E.appendTo(g("#"+r.toolBar))}if(r.insert){g("#"+r.insert).bind("click",function(){var H,G;if(c){$dategrid.datagrid("scrollTo",C);H=$dategrid.datagrid("getEditor",{index:C,field:"fsName"});G=g(H.target).focus().select();return}$dategrid.datagrid("insertRow",{index:0,row:{id:"",fsName:"新建文件夹",isdir:"0"}}).datagrid("beginEdit",0).datagrid("scrollTo",0);C=0;o=1;H=$dategrid.datagrid("getEditor",{index:0,field:"fsName"});G=g(H.target).css("vertical-align","middle");D(G,0);c=true})}if(r.modify){g("#"+r.modify).linkbutton("disable")}if(r.del){f()}if(r.upload){g("#"+r.upload).bind("click",function(){var G=new CommonDialog("uploadFileDialog","500","300","avicit/platform6/yun/pan/content/uploadFile.jsp?type=1&parentId="+w,"上传文件",false,true,false);G.show()})}if(r.lock){g("#"+r.lock).bind("click",function(){g.ajax({url:"platform/span/safe/lock.json",type:"post",dataType:"json",success:function(G){if(G){u(G)}}})})}if(r.save){h()}};return{init:function(F){d(F);return this},loadData:function(){n();return this},fmtFileSize:function(G,H,F){if(G){return formatSize(G)}return"-"},fmtSvrMtime:function(G,H,F){if(G){return new Date(G).format("yyyy-mm-dd hh:nn:ss")}return""},fmtFsName:function(G,H,F){if(H.isdir==="0"){return"<div><span class='dirIcon'></span><a class='dirTitle' onclick='javascript:Safe.clickRow(\""+H.id+'","'+H.fsName+"\",event);'>"+G+"</a></div>"}else{return"<div><span class='"+MIME_TYPE[H.fsMime]+" fileTitle'></span>"+G+"</div>"}},clickRow:function(F,G){n(F,G)},load4Upload:function(){return b()}}}(jQuery));