$(document).bind("contextmenu",function(){return false});var recyclebin=(function($){var $dategrid={},opts={},isEnd=true,loadPage=1,loading=false,_bindClick=function(){$("#"+opts.purge).linkbutton("enable").unbind("click").bind("click",function(){var rows=$dategrid.datagrid("getChecked"),ids=[],l=rows.length;$.messager.confirm("请确认","您确定要彻底删除当前所选的数据？",function(b){if(b){for(;l--;){ids.push(rows[l].id)}$.messager.progress();$.ajax({url:"platform/span/recyle/purge.json",type:"post",data:{ids:JSON.stringify(ids)},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"删除成功！"});_loadById()}else{$.messager.show({title:"提示",msg:r.msg})}}})}})});$("#"+opts.restore).linkbutton("enable").bind("click",function(){var rows=$dategrid.datagrid("getChecked"),ids=[],l=rows.length;for(;l--;){ids.push(rows[l].id)}$.messager.progress();$.ajax({url:"platform/span/recyle/restore.json",type:"post",data:{ids:JSON.stringify(ids)},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"文件还原成功!"});_loadById()}else{if(r.errno==1){$.messager.show({title:"提示",msg:r.msg})}else{if(r.errno==2){$.messager.show({title:"提示",msg:"用户网盘剩余空间不足,成功还原"+r.success+"个文件!"});_loadById()}else{if(r.errno==3){$.messager.show({title:"提示",msg:"成功还原"+r.success+"个文件,还原失败"+r.fail+"个文件,请联系管理员查看日志!"});_loadById()}}}}if(parent&&parent.nav){parent.nav.loadSize()}}})})},checkAll=function(rows){if($dategrid.datagrid("getChecked").length===0){$("#"+opts.purge).linkbutton("disable").unbind("click");$("#"+opts.restore).linkbutton("disable").unbind("click")}else{_bindClick()}},check=function(){if($dategrid.datagrid("getChecked").length===1){_bindClick()}else{if($dategrid.datagrid("getChecked").length===0){$("#"+opts.purge).linkbutton("disable").unbind("click");$("#"+opts.restore).linkbutton("disable").unbind("click")}}};var _int=function(o){opts=$.extend({},{page:1,rows:100,count:100},o);if(opts.grid){$dategrid=$("#"+opts.grid).datagrid({url:null,onCheck:check,onUncheck:check,onCheckAll:checkAll,onUncheckAll:checkAll});$prev=$dategrid.prev().find(".datagrid-body").scroll(function(e){e.preventDefault();e.stopPropagation();if(isEnd){return false}var viewH=$(this).height(),contentH=$(this).get(0).scrollHeight,scrollTop=$(this).scrollTop();if(scrollTop/(contentH-viewH)>=0.98){if(!loading){loadPage++;_loadC(loadPage)}}})}if(opts.toolBar){$toolBar=$('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><span>回收站</span></div>');$toolBar.appendTo($("#"+opts.toolBar))}if(opts.clean){$("#"+opts.clean).linkbutton("disable")}},_loadById=function(){$.messager.progress();$.ajax({url:"platform/span/recyle/getAllItems.json",type:"get",data:{page:opts.page,rows:opts.rows},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}if(r.total>0){$("#"+opts.clean).linkbutton("enable").bind("click",function(){$.messager.confirm("请确认","您确定要清空回收站？",function(b){if(b){$.messager.progress();$.ajax({url:"platform/span/recyle/cleanRecycle.json",type:"post",dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"清空成功！"});_loadById();$("#"+opts.clean).linkbutton("disable").unbind("click")}else{$.messager.show({title:"提示",msg:r.msg})}}})}})})}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadC=function(_page){loading=true;$.messager.progress();$.ajax({url:"platform/span/recyle/getAllItems.json",type:"get",data:{page:_page,rows:opts.rows},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){var old=$dategrid.datagrid("getRows"),length=r.rows.length;for(;length--;){old.push(r.rows.shift())}if(r.total>_page*opts.rows){$("#navTips").text("已加载"+_page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}$dategrid.datagrid("loadData",old).datagrid("clearChecked")}else{$.messager.show({title:"加载失败！",msg:r.msg})}loading=false}});return this};return{"init":function(o){_int(o);return this},"loadData":function(){_loadById();return this},"fmtFileSize":function(value,row,index){if(value){return parent.nav.formateSize(value)}return"-"},"fmtSvrDtime":function(value,row,index){if(value){return new Date(value).format("yyyy-mm-dd hh:nn:ss")}return""},"fmtFsName":function(value,row,index){if(row.isdir==="0"){return"<div><span class='dirIcon dirTitle'></span>"+value+"</div>"}else{return"<div><span class='"+MIME_TYPE[row.fsMime]+" fileTitle'></span>"+value+"</div>"}}}}(jQuery));$(function(){recyclebin.init({"grid":"recycle","restore":"restore","purge":"purge","clean":"cleanRecycle","toolBar":"toolRecycle"}).loadData()});