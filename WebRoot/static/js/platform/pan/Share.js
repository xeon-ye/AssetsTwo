$(document).bind("contextmenu",function(){return false});var Share=(function($){var $dategrid={},opts={},isEnd=true,loadPage=1,loading=false,parentId="-1",histParent=[],$history,status=true,_bindClick=function(){$("#"+opts.unShare).linkbutton("enable").unbind("click").bind("click",function(){var rows=$dategrid.datagrid("getChecked"),objs=[],l=rows.length;$.messager.confirm("请确认","您确定要取消共享当前所选的数据？",function(b){if(b){for(;l--;){objs.push({"key":rows[l].id,"value":rows[l].fsName})}$.messager.progress();$.ajax({url:"platform/span/share/unshare.json",type:"post",data:{objs:JSON.stringify(objs)},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"取消共享成功！"});_loadById()}else{$.messager.show({title:"提示",msg:r.msg})}}})}})})},checkAll=function(rows){if(!status){$("#"+opts.unShare).linkbutton("disable").unbind("click");return false}if($dategrid.datagrid("getChecked").length===0){$("#"+opts.unShare).linkbutton("disable").unbind("click")}else{_bindClick()}},check=function(){if(!status){$("#"+opts.unShare).linkbutton("disable").unbind("click");return false}var l=$dategrid.datagrid("getChecked").length;if(l===0){$("#"+opts.unShare).linkbutton("disable").unbind("click")}else{_bindClick()}},_int=function(o){opts=$.extend({},{page:1,rows:100,count:100},o);if(opts.grid){$dategrid=$("#"+opts.grid).datagrid({url:null,onCheck:check,onUncheck:check,onCheckAll:checkAll,onUncheckAll:checkAll});$prev=$dategrid.prev().find(".datagrid-body").scroll(function(e){e.preventDefault();e.stopPropagation();if(isEnd){return false}var viewH=$(this).height(),contentH=$(this).get(0).scrollHeight,scrollTop=$(this).scrollTop();if(scrollTop/(contentH-viewH)>=0.98){if(!loading){loadPage++;_loadC(loadPage)}}})}if(opts.toolBar){$history=$('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><div id="hisContent"></div></div>');$history.appendTo($("#"+opts.toolBar))}},_loadById=function(pid,name){status=true;parentId=pid||parentId;loadPage=1;$.messager.progress();$.ajax({url:"platform/span/share/getSpanShareItems.json",type:"get",data:{page:opts.page,rows:opts.rows},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");if(parentId!=="-1"){_listHistory()}else{_clearHistory()}if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadA=function(pid,name){status=false;parentId=pid||parentId;loadPage=1;$.messager.progress();$.ajax({url:"platform/span/content/getSpanAllItem.json",type:"get",data:{page:opts.page,rows:opts.rows,parentId:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");histParent.push({id:parentId,text:name});if(parentId!=="-1"){_listHistory()}else{_clearHistory()}if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadB=function(pid,name){status=false;parentId=pid||parentId;loadPage=1;$.messager.progress();$.ajax({url:"platform/span/content/getSpanAllItem.json",type:"get",data:{page:opts.page,rows:opts.rows,parentId:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");if(parentId!=="-1"){_listHistory()}else{_clearHistory()}if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadC=function(_page){loading=true;$.messager.progress();$.ajax({url:"platform/span/share/getSpanShareItems.json",type:"get",data:{page:_page,rows:opts.rows},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){var old=$dategrid.datagrid("getRows"),length=r.rows.length;for(;length--;){old.push(r.rows.shift())}if(r.total>_page*opts.rows){$("#navTips").text("已加载"+_page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}$dategrid.datagrid("loadData",old).datagrid("clearChecked")}else{$.messager.show({title:"加载失败！",msg:r.msg})}loading=false}});return this},_listHistory=function(){var length=histParent.length,i=0;var $hisContent=$("#hisContent");$hisContent.empty();$('<a href="javastript:void(0);" title="返回上一级">返回上一级</a>').bind("click",function(){histParent.pop();if(histParent.length==0){_loadById("-1");return false}_loadB(histParent[histParent.length-1].id);return false}).appendTo($hisContent);$("<span>|</span>").appendTo($hisContent);$('<a href="javastript:void(0);" title="全部文件">全部文件</a>').bind("click",function(){histParent=[];_loadById("-1");return false
}).appendTo($hisContent);$("<span>&gt;</span>").appendTo($hisContent);for(;i<length;i++){if(histParent[i].id==="-1"){}else{if(i===length-1){$("<span>"+histParent[i].text+"</span>").appendTo($hisContent)}else{(function(_i){$('<a href="javastript:void(0);" title="'+histParent[_i].text+'">'+histParent[_i].text+"</a>").bind("click",function(){var clickId=histParent[_i].id;var newHist=[];for(var i=0;i<histParent.length;i++){newHist.push(histParent[i]);if(histParent[i].id==clickId){break}}histParent=newHist;_loadB(clickId);return false}).appendTo($hisContent);$("<span>&gt;</span>").appendTo($hisContent)})(i)}}}},_clearHistory=function(){var $hisContent=$("#hisContent");$hisContent.empty();$("<span>全部文件</span>").appendTo($hisContent)};return{"init":function(o){_int(o);return this},"loadData":function(){_loadById();return this},"fmtFileSize":function(value,row,index){if(value){return parent.nav.formateSize(value)}return"-"},"fmtFsName":function(value,row,index){if(row.isdir==="0"){return"<div><span class='dirIcon'></span><a class='dirTitle' onclick='javascript:Share.loadA(\""+row.id+'","'+row.fsName+"\",event);'>"+value+"</a></div>"}else{return"<div><span class='"+MIME_TYPE[row.fsMime]+" fileTitle'></span>"+value+"</div>"}},"fmtSvrStime":function(value,row,index){if(value){return new Date(value).format("yyyy-mm-dd hh:nn:ss")}return""},"loadA":_loadA}}(jQuery));$(function(){Share.init({grid:"myShareContent",unShare:"unShare",toolBar:"toolMyShare"}).loadData()});