$(document).bind("contextmenu",function(){return false});(function($){$.fn.spanContent=function(options){var opts=$.extend({},$.fn.spanContent.defaults,options),base=this,editing=false,editingIndex=0,iOrM=0,_clickM=function(){$("#"+opts.modify).linkbutton("enable").bind("click",function(){var ed,$ed,index,checkedRow;if(editing){$dategrid.datagrid("scrollTo",editingIndex);ed=$dategrid.datagrid("getEditor",{index:editingIndex,field:"fsName"});$ed=$(ed.target).focus().select();return}checkedRow=$dategrid.datagrid("getChecked")[0];if(!checkedRow){return}index=$dategrid.datagrid("getRowIndex",checkedRow);ed=$dategrid.datagrid("beginEdit",index).datagrid("getEditor",{index:index,field:"fsName"});editingIndex=index;iOrM=2;$ed=$(ed.target).css("vertical-align","middle");_enhanceModify($ed,index,checkedRow);editing=true})},_clickD=function(){$("#"+opts.down).linkbutton("enable").unbind("click").bind("click",function(){var rows=$dategrid.datagrid("getChecked"),objs=[],l=rows.length;for(;l--;){objs.push({"key":rows[l].id,"value":rows[l].ownerId})}var downloadUrl="platform/span/content/down?objs="+JSON.stringify(objs);new DownLoad4URL("iframe","form",null,downloadUrl).downLoad()})},checkAll=function(){$("#"+opts.down).linkbutton("disable").unbind("click");$("#"+opts.modify).linkbutton("disable").unbind("click")},check=function(){var rows=$dategrid.datagrid("getChecked");if(rows.length===1){_clickM();if(rows[0].isdir=="1"){_clickD()}}else{$("#"+opts.modify).linkbutton("disable").unbind("click");$("#"+opts.down).linkbutton("disable").unbind("click")}},$dategrid=base.datagrid({url:null,onCheck:check,onUncheck:check,onCheckAll:checkAll,onUncheckAll:checkAll}),parentId="-1",histParent=[],$history,loading=false,isEnd=true,loadPage=1,$prev=$dategrid.prev().find(".datagrid-body");$prev.scroll(function(e){e.preventDefault();e.stopPropagation();if(isEnd){return false}var viewH=$(this).height(),contentH=$(this).get(0).scrollHeight,scrollTop=$(this).scrollTop();if(scrollTop/(contentH-viewH)>=0.98){if(!loading){loadPage++;_loadC(loadPage)}}});if(opts.toolBar){$history=$('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><div id="hisContent"></div></div>');$history.appendTo($("#"+opts.toolBar))}var _enhanceInsert=function(target,index){(function(i){var $sure=$('<span class="sure"></span>'),$cancel=$('<span class="cancel"></span>');target.css("width",target.width()-58).after($cancel).after($sure).bind("keydown",function(event){if(event.keyCode==13){event.preventDefault();event.stopPropagation();_createDir(0)}else{if(event.keyCode==27){$dategrid.datagrid("deleteRow",i);editing=false;return false}}});$sure.bind("click",function(){_createDir(i)});$cancel.bind("click",function(){$dategrid.datagrid("deleteRow",i);editing=false})})(index)},_enhanceModify=function(target,index,row){var $sure=$('<span class="sure"></span>'),$cancel=$('<span class="cancel"></span>');(function(i,r){target.css("width",target.width()-58).after($cancel).after($sure).bind("keydown",function(event){if(event.keyCode==13){event.preventDefault();event.stopPropagation();_rename(i,r)}else{if(event.keyCode==27){$dategrid.datagrid("cancelEdit",i).datagrid("uncheckRow",i);editing=false;return false}}});$sure.bind("click",function(){_rename(i,r)});$cancel.bind("click",function(){$dategrid.datagrid("cancelEdit",i).datagrid("uncheckRow",i);editing=false})})(index,row)},_createDir=function(i){var val=$($dategrid.datagrid("getEditor",{index:0,field:"fsName"}).target).val();if(checkName(val)){return}val=trim(val);$.messager.progress();$.ajax({url:"platform/span/content/create.json",type:"post",data:{text:val,parent:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("updateRow",{index:i,row:{id:r.fid,fsName:r.name,svrMtime:r.svrMtime}});editing=false;var txt=$("#navTips").text(),begin=txt.indexOf("已加载全部");if(begin!==0){$("#navTips").text("已加载"+(parseInt(txt.slice(3,txt.length-1))+1)+"个")}else{$("#navTips").text("已加载全部,共"+(parseInt(txt.slice(7,txt.length-1))+1)+"个")}}else{$.messager.show({title:"创建文件夹失败！",msg:r.msg})}}})},_rename=function(i,r){var val=$($dategrid.datagrid("getEditor",{index:i,field:"fsName"}).target).val();if(val===r.fsName){$dategrid.datagrid("cancelEdit",i).datagrid("uncheckRow",i);editing=false;return false}if(checkName(val)){return false}val=trim(val);$.messager.progress();$.ajax({url:"platform/span/content/rename.json",type:"post",data:{text:val,id:r.id,type:r.isdir,s:r.isshare},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("updateRow",{index:i,row:{fsName:r.name,svrMtime:r.svrMtime,fsMime:r.extName}}).datagrid("uncheckRow",i);editing=false}else{$.messager.show({title:"重命名失败！",msg:r.msg})}}})},checkName=function(name){if(!name){alert("文件夹名称不能为空");return true}if((/[\\/\:\?\"<>\*]+/).test(name)){alert("文件名不能包含以下字符：<,>,|,*,?,,/");return true}return false},trim=function(str){return str.replace(/^\s*|\s*$/g,"")},_loadById=function(pid,name){parentId=pid||parentId;
    loadPage=1;$.messager.progress();$.ajax({url:"platform/span/content/getSpanAllItem.json",type:"get",data:{page:opts.page,rows:opts.rows,parentId:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");histParent.push({id:parentId,text:name});if(parentId!=="-1"){_listHistory()}else{_clearHistory()}if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadA=function(pid,name){parentId=pid||parentId;$.messager.progress();loadPage=1;$.ajax({url:"platform/span/content/getSpanAllItem.json",type:"get",data:{page:opts.page,rows:opts.rows,parentId:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$dategrid.datagrid("loadData",r.rows).datagrid("clearChecked");if(parentId!=="-1"){_listHistory()}else{_clearHistory()}if(r.total>opts.page*opts.rows){$("#navTips").text("已加载"+opts.page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}}else{$.messager.show({title:"加载失败！",msg:r.msg})}}});return this},_loadC=function(_page){loading=true;if(editing){if(iOrM===1){$dategrid.datagrid("deleteRow",editingIndex)}else{if(iOrM===2){$dategrid.datagrid("cancelEdit",editingIndex).datagrid("uncheckRow",editingIndex)}}editing=false}$.messager.progress();$.ajax({url:"platform/span/content/getSpanAllItem.json",type:"get",data:{page:_page,rows:opts.rows,parentId:parentId},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){var old=$dategrid.datagrid("getRows");var length=r.rows.length;for(;length--;){old.push(r.rows.shift())}if(r.total>_page*opts.rows){$("#navTips").text("已加载"+_page*opts.rows+"个");isEnd=false}else{$("#navTips").text("已加载全部,共"+r.total+"个");isEnd=true}$dategrid.datagrid("loadData",old).datagrid("clearChecked")}else{$.messager.show({title:"加载失败！",msg:r.msg})}loading=false}});return this},_listHistory=function(){var length=histParent.length,i=0;var $hisContent=$("#hisContent");$hisContent.empty();$('<a href="javastript:void(0);" title="返回上一级">返回上一级</a>').bind("click",function(){histParent.pop();_loadA(histParent[histParent.length-1].id);return false}).appendTo($hisContent);$("<span>|</span>").appendTo($hisContent);$('<a href="javastript:void(0);" title="全部文件">全部文件</a>').bind("click",function(){histParent=[];_loadById("-1");return false}).appendTo($hisContent);$("<span>&gt;</span>").appendTo($hisContent);for(;i<length;i++){if(histParent[i].id==="-1"){}else{if(i===length-1){$("<span>"+histParent[i].text+"</span>").appendTo($hisContent)}else{(function(_i){$('<a href="javastript:void(0);" title="'+histParent[_i].text+'">'+histParent[_i].text+"</a>").bind("click",function(){var clickId=histParent[_i].id;var newHist=[];for(var i=0;i<histParent.length;i++){newHist.push(histParent[i]);if(histParent[i].id==clickId){break}}histParent=newHist;_loadA(clickId);return false}).appendTo($hisContent);$("<span>&gt;</span>").appendTo($hisContent)})(i)}}}},_shareItem=function(rowIndex,retValue,dialogDivId){var rows=$dategrid.datagrid("getChecked"),ids=[],fileName=[],l=rows.length;for(;l--;){ids.push(rows[l].id);fileName.push(rows[l].fsName)}$.messager.progress();$.ajax({url:"platform/span/share/share.json",type:"post",data:{ids:JSON.stringify(ids),fileNames:JSON.stringify(fileName),userIds:retValue.userId,userNames:retValue.userName},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"共享成功！"})}else{$.messager.show({title:"提示",msg:r.msg})}}})},_clearHistory=function(){var $hisContent=$("#hisContent");$hisContent.empty();$("<span>全部文件</span>").appendTo($hisContent)};if(opts.insert){$("#"+opts.insert).bind("click",function(){var ed,$ed;if(editing){$dategrid.datagrid("scrollTo",editingIndex);ed=$dategrid.datagrid("getEditor",{index:editingIndex,field:"fsName"});$ed=$(ed.target).focus().select();return}$dategrid.datagrid("insertRow",{index:0,row:{id:"",fsName:"新建文件夹",isdir:"0"}}).datagrid("beginEdit",0).datagrid("scrollTo",0);editingIndex=0;iOrM=1;ed=$dategrid.datagrid("getEditor",{index:0,field:"fsName"});$ed=$(ed.target).css("vertical-align","middle");_enhanceInsert($ed,0);editing=true})}if(opts.modify){$("#"+opts.modify).linkbutton("disable")}if(opts.del){$("#"+opts.del).bind("click",function(){var rows=$dategrid.datagrid("getChecked"),ids=[],l=rows.length;if(l){$.messager.confirm("请确认","您确定要删除当前所选的数据？",function(b){if(b){for(;l--;){ids.push(rows[l].id)}$.messager.progress();$.ajax({url:"platform/span/content/delete.json",type:"post",data:{ids:JSON.stringify(ids)},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"删除成功！"});_loadA();if(parent&&parent.nav){parent.nav.loadSize().needReycble()}}else{$.messager.show({title:"提示",msg:r.msg})}}})}})}else{$.messager.alert("提示","请选择要删除的记录！","warning")
}})}if(opts.upload){$("#"+opts.upload).bind("click",function(){var dialog=new CommonDialog("uploadFileDialog","500","300","avicit/platform6/yun/pan/content/uploadFile.jsp?type=0&parentId="+parentId,"上传文件",false,true,false);dialog.show()})}if(opts.share){$("#"+opts.share).bind("click",function(){if($dategrid.datagrid("getChecked").length==0){$.messager.alert("提示","请选择要共享的记录！","warning")}else{$.messager.confirm("请确认","您确定要共享当前所选的数据？",function(b){if(b){userSelect=new GridCommonSelector("user","","","",{},_shareItem,null,null,null,false,null,null,"2").init()}})}})}if(opts.transfer){$("#"+opts.transfer).bind("click",function(){if($dategrid.datagrid("getChecked").length==0){$.messager.alert("提示","请选择要转入文件保险箱的记录！","warning")}else{$.messager.confirm("请确认","您确定转入文件保险箱？",function(b){if(b){var rows=$dategrid.datagrid("getChecked"),objs=[],l=rows.length;for(;l--;){objs.push({key:rows[l].id,value:rows[l].fsName})}$.messager.progress();$.ajax({url:"platform/span/content/transfer2safe.json",type:"post",data:{objs:JSON.stringify(objs)},dataType:"json",success:function(r){$.messager.progress("close");if(r&&r.errno==0){$.messager.show({title:"提示",msg:"成功转入！"});_loadA()}else{$.messager.show({title:"提示",msg:r.msg})}}})}})}})}return{loadById:_loadById,load4Upload:_loadA}};$.fn.spanContent.defaults={page:1,rows:100,count:100}}(jQuery));