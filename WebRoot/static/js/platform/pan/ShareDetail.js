$(document).bind("contextmenu",function(){return false;});var ShareDetail=(function(f){var a={},m={},j=true,e=false,i="",c=[],g="",s="",o="-1",h=1,p=[],u,t=function(y){var w=a.datagrid("getChecked"),x=[],v=w.length;for(;v--;){x.push({key:w[v].id,value:g,value1:s})}f.messager.progress();f.ajax({url:"platform/span/content/save2mypan/"+y.id+"/"+g+"/"+s+".json",type:"post",data:{objs:JSON.stringify(x)},dataType:"json",success:function(z){f.messager.progress("close");if(z&&z.errno==0){f.messager.show({title:"提示",msg:"保存成功！"})}else{f.messager.show({title:"提示",msg:z.msg})}}})},b=function(){f("#"+m.save).linkbutton("enable").unbind("click").bind("click",function(){dirTree.show("保存到");dirTree.setOkBack(t)})},l=function(){f("#"+m.downLoad).linkbutton("enable").unbind("click").bind("click",function(){var w=a.datagrid("getChecked"),y=[],v=w.length;for(;v--;){y.push({key:w[v].id,value:g,value1:s})}var x="platform/span/content/down?objs="+JSON.stringify(y);new DownLoad4URL("iframe","form",null,x).downLoad()})},k=function(v){f("#"+m.downLoad).linkbutton("disable").unbind("click");if(a.datagrid("getChecked").length===0){f("#"+m.save).linkbutton("disable").unbind("click")}else{b()}},r=function(y,w){var x=a.datagrid("getChecked"),v=x.length;if(v===0){f("#"+m.save).linkbutton("disable").unbind("click");f("#"+m.downLoad).linkbutton("disable").unbind("click")}else{if(v===1&&x[0].isdir=="1"){l();b()}else{b();f("#"+m.downLoad).linkbutton("disable").unbind("click")}}},d=function(v){m=f.extend({},{page:1,rows:100,count:100},v);if(m.grid){a=f("#"+m.grid).datagrid({url:null,onCheck:r,onUncheck:r,onCheckAll:k,onUncheckAll:k});$prev=a.prev().find(".datagrid-body").scroll(function(z){z.preventDefault();z.stopPropagation();if(j){return false}var w=f(this).height(),x=f(this).get(0).scrollHeight,y=f(this).scrollTop();if(y/(x-w)>=0.98){if(!e){h++;_loadC(h)}}})}if(m.toolBar){u=f('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><div id="hisContent"></div></div>');u.appendTo(f("#"+m.toolBar))}},q=function(){var x=p.length,v=0;var w=f("#hisContent");w.empty();f('<a href="javastript:void(0);" title="返回上一级">返回上一级</a>').bind("click",function(){p.pop();if(p.length===0){p=[];a.datagrid("loadData",{rows:c});n();f("#navTips").text("已加载全部,共1个")}else{_loadA(p[p.length-1].id)}return false}).appendTo(w);f("<span>|</span>").appendTo(w);f('<a href="javastript:void(0);" title="全部文件">全部文件</a>').bind("click",function(){p=[];a.datagrid("loadData",{rows:c});n();f("#navTips").text("已加载全部,共1个");return false}).appendTo(w);f("<span>&gt;</span>").appendTo(w);for(;v<x;v++){if(p[v].id==="-1"){}else{if(v===x-1){f("<span>"+p[v].text+"</span>").appendTo(w)}else{(function(y){f('<a href="javastript:void(0);" title="'+p[y].text+'">'+p[y].text+"</a>").bind("click",function(){var z=p[y].id;var B=[];for(var A=0;A<p.length;A++){B.push(p[A]);if(p[A].id==z){break}}p=B;_loadA(z);return false}).appendTo(w);f("<span>&gt;</span>").appendTo(w)})(v)}}}},n=function(){var v=f("#hisContent");v.empty();f("<span>全部文件</span>").appendTo(v)};_loadByPid=function(v,w){o=v||o;h=1;f.messager.progress();f.ajax({url:i,type:"get",data:{page:m.page,rows:m.rows,parentId:o},dataType:"json",success:function(x){f.messager.progress("close");if(x&&x.errno==0){a.datagrid("loadData",x.rows).datagrid("clearChecked");p.push({id:o,text:w});if(o!=="-1"){q()}else{n()}if(x.total>m.page*m.rows){f("#navTips").text("已加载"+m.page*m.rows+"个");j=false}else{f("#navTips").text("已加载全部,共"+x.total+"个");j=true}}else{f.messager.show({title:"加载失败！",msg:x.msg})}}})},_loadA=function(v,w){o=v||o;f.messager.progress();h=1;f.ajax({url:i,type:"get",data:{page:m.page,rows:m.rows,parentId:o},dataType:"json",success:function(x){f.messager.progress("close");if(x&&x.errno==0){a.datagrid("loadData",x.rows).datagrid("clearChecked");if(o!=="-1"){q()}else{n()}if(x.total>m.page*m.rows){f("#navTips").text("已加载"+m.page*m.rows+"个");j=false}else{f("#navTips").text("已加载全部,共"+x.total+"个");j=true}}else{f.messager.show({title:"加载失败！",msg:x.msg})}}})},_loadC=function(v){e=true;f.messager.progress();f.ajax({url:i,type:"get",data:{page:v,rows:m.rows},dataType:"json",success:function(y){f.messager.progress("close");if(y&&y.errno==0){var w=a.datagrid("getRows"),x=y.rows.length;for(;x--;){w.push(y.rows.shift())}if(y.total>v*m.rows){f("#navTips").text("已加载"+v*m.rows+"个");j=false}else{f("#navTips").text("已加载全部,共"+y.total+"个");j=true}a.datagrid("loadData",w).datagrid("clearChecked")}else{f.messager.show({title:"加载失败！",msg:y.msg})}e=false}})},_toDetail=function(v){window.open(getPath2()+"/platform/span/share/"+v+".html","blank")};return{init:function(v){d(v);return this},loadData:function(v){f("#subTitle").text(v.fsName);f(".shared-detail-subtitle").attr("title",v.fsName);f(".share-detail-title").css("width",f("#mytr").width()-f("#del").width()-f("#saveMy").width()-f("#downLoad").width());f("#"+m.del).bind("click",function(w){f.messager.confirm("请确认","您确定要删除当前共享数据？",function(x){if(x){f.messager.progress();f.ajax({url:"platform/span/share/del.json",type:"post",data:{objs:JSON.stringify([{key:v.mid,value:v.fsName}])},dataType:"json",success:function(y){window.close()}})}})});f("#"+m.save).linkbutton("disable");f("#"+m.downLoad).linkbutton("disable");if(v.errno!==0){return}f(".shared-detail-subtitle").addClass(MIME_TYPE[v.fsMime]);f(".share-time").attr("title",v.shareTime).text(v.shareTime);g=v.sid;s=v.id;i="platform/span/content/"+g+"/"+s+"/getSpanAllItem";c=[v];a.datagrid("loadData",{rows:c});n();f("#navTips").text("已加载全部,共1个");return this},fmtFileSize:function(w,x,v){if(w){return formatSize(w)}return"-"},fmtSvrMtime:function(w,x,v){if(w){return new Date(w).format("yyyy-mm-dd hh:nn:ss")}return""},fmtFsName:function(w,x,v){if(x.isdir==="0"){return"<div><span class='dirIcon dirTitle'></span><a href='javascript:void(0);' onclick='ShareDetail.clickRow(\""+x.id+'","'+x.fsName+"\",event);'>"+w+"</a></div>"}else{return"<div><span class='"+MIME_TYPE[x.fsMime]+" fileTitle'></span><a href='javascript:void(0);'>"+w+"</a></div>"}},clickRow:function(v,w){_loadByPid(v,w)}}}(jQuery));