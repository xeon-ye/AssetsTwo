$(document).bind("contextmenu",function(){return false});var Shared=(function($){var $dategrid={},$toolBar,opts={},isEnd=true,loadPage=1,loading=false,_bindClick=function(){$("#"+opts.del).linkbutton('enable').bind("click",function(e){var rows=$dategrid.datagrid('getChecked'),objs=[],l=rows.length;$.messager.confirm('请确认','您确定要删除当前所选的数据？',function(b){if(b){for(;l--;){objs.push({"key":rows[l].id,"value":rows[l].fsName})}$.messager.progress();$.ajax({url:'platform/span/share/del.json',type:'post',data:{"objs":JSON.stringify(objs)},dataType:'json',success:function(r){$.messager.progress('close');if(r&&r.errno==0){$.messager.show({title:'提示',msg:'删除成功！'});_loadById()}else{$.messager.show({title:'提示',msg:r.msg})}}})}})})},_saveShared=function(o){var rows=$dategrid.datagrid('getChecked'),objs=[],l=rows.length;for(;l--;){objs.push({"key":rows[l].spanItemId,"value":rows[l].ownerId,"value1":rows[l].fsName})}$.messager.progress();$.ajax({url:'platform/span/content/savedif2mypan/'+o.id+'.json',type:'post',data:{objs:JSON.stringify(objs)},dataType:'json',success:function(r){$.messager.progress('close');if(r&&r.errno==0){$.messager.show({title:'提示',msg:'保存成功！'})}else if(r&&r.errno==5){_loadById();alert(r.tip)}else{$.messager.show({title:'提示',msg:r.msg})}if(parent&&parent.nav){parent.nav.loadSize()}}})},_bindSaveClick=function(){$("#"+opts.save).linkbutton('enable').bind("click",function(e){dirTree.show('保存到');dirTree.setOkBack(_saveShared)})},checkAll=function(rows){if($dategrid.datagrid('getChecked').length===0){$("#"+opts.del).linkbutton('disable').unbind("click");$("#"+opts.save).linkbutton('disable').unbind("click")}else{_bindClick();_bindSaveClick()}$("#"+opts.down).linkbutton('disable').unbind("click")},check=function(){var rows=$dategrid.datagrid('getChecked');if(rows.length===1){_bindClick();_bindSaveClick();if($dategrid.datagrid('getChecked')[0].isdir=="1"){$('#'+opts.down).linkbutton('enable').unbind('click').bind("click",function(){var rows=$dategrid.datagrid('getChecked'),objs=[],l=rows.length;for(;l--;){objs.push({"key":rows[l].spanItemId,"value":rows[l].ownerId})}var downloadUrl="platform/span/content/share/down?objs="+JSON.stringify(objs);new DownLoad4URL('iframe','form',null,downloadUrl).downLoad()})}return}else if(rows.length===0){$("#"+opts.del).linkbutton('disable').unbind("click");$("#"+opts.save).linkbutton('disable').unbind("click")}else if(rows.length===2){$("#"+opts.down).linkbutton('disable').unbind("click")}},_int=function(o){opts=$.extend({},{page:1,rows:100,count:100},o);if(opts.grid){$dategrid=$('#'+opts.grid).datagrid({url:null,onCheck:check,onUncheck:check,onCheckAll:checkAll,onUncheckAll:checkAll});$prev=$dategrid.prev().find('.datagrid-body').scroll(function(e){e.preventDefault();e.stopPropagation();if(isEnd){return false}var viewH=$(this).height(),contentH=$(this).get(0).scrollHeight,scrollTop=$(this).scrollTop();if(scrollTop/(contentH-viewH)>=0.98){if(!loading){loadPage++;_loadC(loadPage)}}})}if(opts.toolBar){$toolBar=$('<div class="navigation"><p><span id="navTips">已全部加载:共0个</span></p><span>全部文件（系统将自动清理分享文件被删除超过1个月以上的链接记录）</span></div>');$toolBar.appendTo($("#"+opts.toolBar))}},_loadById=function(){$.messager.progress();$.ajax({url:'platform/span/share/getSpanSharedItems.json',type:'get',data:{page:opts.page,rows:opts.rows},dataType:'json',success:function(r){$.messager.progress('close');if(r&&r.errno==0){$dategrid.datagrid('loadData',r.rows).datagrid('clearChecked');if(r.total>opts.page*opts.rows){$('#navTips').text('已加载'+opts.page*opts.rows+'个');isEnd=false}else{$('#navTips').text('已加载全部,共'+r.total+'个');isEnd=true}}else{$.messager.show({title:'加载失败！',msg:r.msg})}}});return this},_loadC=function(_page){loading=true;$.messager.progress();$.ajax({url:'platform/span/share/getSpanSharedItems.json',type:'get',data:{page:_page,rows:opts.rows},dataType:'json',success:function(r){$.messager.progress('close');if(r&&r.errno==0){var old=$dategrid.datagrid('getRows'),length=r.rows.length;for(;length--;){old.push(r.rows.shift())}if(r.total>_page*opts.rows){$('#navTips').text('已加载'+_page*opts.rows+'个');isEnd=false}else{$('#navTips').text('已加载全部,共'+r.total+'个');isEnd=true}$dategrid.datagrid('loadData',old).datagrid('clearChecked')}else{$.messager.show({title:'加载失败！',msg:r.msg})}loading=false}});return this},_toDetail=function(id){window.open(getPath2()+"/platform/span/share/"+id+".html","blank")};return{"init":function(o){_int(o);return this},"loadData":function(){_loadById();return this},"fmtFileSize":function(value,row,index){if(value){return formatSize(value)}return'-'},"fmtSvrCtime":function(value,row,index){if(value){return new Date(value).format("yyyy-mm-dd hh:nn:ss")}return''},"fmtFsName":function(value,row,index){if(row.isdir==="0"){return"<div><span class='dirIcon dirTitle'></span><a href='javascript:void(0);' onclick='Shared.detail(\""+row.id+"\");return false;'>"+value+"</a></div>"}else{return"<div><span class='"+MIME_TYPE[row.fsMime]+" fileTitle'></span><a href='javascript:void(0);' onclick='Shared.detail(\""+row.id+"\");return false;'>"+value+"</a></div>"}},"detail":function(id){_toDetail(id)}}}(jQuery));