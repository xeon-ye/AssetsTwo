tinymce.PluginManager.add("tabmanage", function(editor) {

    var tabElement;

    editor.addButton('tabManage', {
        text: '标签页',
        icon: false,
        onclick: function () {
            var id1= GenNonDuplicateID(),id2=GenNonDuplicateID();

            editor.insertContent("<div class=\"eform-tab\" style='border: 1px dashed #BBB;' contenteditable=\"false\"><ul class=\"nav nav-tabs\" role=\"tablist\" >\n" +
                "<li role=\"presentation\" onclick=\"if (window.jQuery){$(window).trigger('resize');}\" class=\"presentation eform-form-tab active\" contenteditable=\"false\"><a href=\"#"+id1+"\" aria-controls=\""+id1+"\" role=\"tab\" data-toggle=\"tab\">页签1</a></li>\n" +
                "<li role=\"presentation\" onclick=\"if (window.jQuery){$(window).trigger('resize');}\" class=\"presentation eform-form-tab\" contenteditable=\"false\"><a href=\"#"+id2+"\" aria-controls=\""+id2+"\" role=\"tab\" data-toggle=\"tab\">页签2</a></li>\n" +
                "</ul>\n" +
                "<div class=\"tab-content\" style=\"height: 100%; min-height: 40px;\">\n" +
                "<div role=\"tabpanel\" class=\"tab-pane active\" contenteditable=\"true\" id=\""+id1+"\" style=\"height: 100%; min-height: 40px;\"></div>\n" +
                "<div role=\"tabpanel\" class=\"tab-pane\" contenteditable=\"true\" id=\""+id2+"\" style=\"height: 100%; min-height: 40px;\"></div>\n" +
                "</div></div>");
        }
    });

    editor.on('click', function(e){
        if (e.type === 'setcontent' && !e.selection) {
            return;
        }
        var node = editor.selection.getNode();

        if ($(node).hasClass("presentation")){
            var tabId = $(node).find("a").attr("aria-controls");
            $(node).parent().children(".active").removeClass("active");
            $(node).addClass("active");
            $(node).parent().next().children(".active").removeClass("active");
            $(node).parent().next().children("#"+tabId).addClass("active");
        }

    });
    editor.addButton('tabprops', {
        title: '标签页属性',
        onclick: function () {propsTab(tabElement)},
        icon: 'settings'
    });

    editor.addButton('tabdelete', {
        title: '删除标签页',
        onclick: function () {deleteTab(tabElement);},
        icon: 'remove'
    });

    function isTab(tab) {

        var selectorMatched = $(tab).hasClass("eform-tab") && editor.getBody().contains(tab);
        if (selectorMatched){
            tabElement = tab;
        }
        return selectorMatched;
    }

    var tabtoolbarItems = 'tabprops tabdelete ';

    editor.addContextToolbar(
        isTab,
        tabtoolbarItems
    );

    function isEditorBody(node) {
        return node === editor.getBody();
    }

    function deleteTab(tab) {
        var rng = editor.selection.dom.createRng();

        if (isEditorBody(tab)) {
            return;
        }

        rng.setStartAfter(tab);
        rng.setEndAfter(tab);

        editor.selection.setRng(rng);

        editor.selection.dom.remove(tab);
    }

    function propsTab(tab){
        layer.open({
            type: 2,
            title: "tab页签属性",
            skin: 'layui-layer-rim',
            area: ['70%', '80%'],
            content: 'static/js/platform/eform/tinymce/plugins/tabmanage/tabprops.jsp',
            btn: ['确认', '取消'],
            success: function (layero, index) {
                var iframeWin = layero.find('iframe')[0].contentWindow;
                var tabList = [];
                $(tab).children("ul").children(".presentation").each(function () {
                    var $a = $(this).find("a");
                    var tabId = $a.attr("aria-controls");
                    var tabname = $a.text();
                    var obj = {tabname:tabname,tabid:tabId}
                    tabList.push(obj);

                });
                iframeWin.init(tabList);
            },
            yes: function (index,layero) {
                var iframeWin = layero.find('iframe')[0].contentWindow;
                var jsonlist = iframeWin.dataJsonList;
                if (jsonlist && jsonlist.length>0){
                    var liarray = $(tab).children("ul").children(".presentation");
                    var licount = liarray.length;
                    for (var i=0;i<jsonlist.length;i++){
                        var id = jsonlist[i].data.tabid,name = jsonlist[i].data.tabname;
                        var li = liarray.eq(i);
                        if (li && li.length>0) {
                            var hasactive = li.hasClass("active");
                            var $a = li.find("a");
                            var tabId = $a.attr("aria-controls");
                            $a.attr("aria-controls",id);
                            $a.attr("href","#"+id);
                            $a.attr("data-mce-href","#"+id);
                            $a.text(name);
                            if ($(tab).find("#"+id).length==0) {
                                $(tab).find("#" + tabId).attr("id", id);
                            }
                            if (hasactive){
                                li.parent().next().children(".active").removeClass("active");
                                li.parent().next().children("#"+id).addClass("active");
                            }
                        }else{
                            $(tab).children("ul").append("<li role=\"presentation\" onclick=\"if (window.jQuery){$(window).trigger('resize');}\" class=\"presentation eform-form-tab\" contenteditable=\"false\"><a href=\"#"+id+"\" aria-controls=\""+id+"\" role=\"tab\" data-toggle=\"tab\">"+name+"</a></li>\n");
                            $(tab).children(".tab-content").append("<div role=\"tabpanel\" class=\"tab-pane\" contenteditable=\"true\" id=\""+id+"\" style=\"height: 100%; min-height: 40px;\"></div>\n");
                        }
                    }
                    if (licount>jsonlist.length){
                        liarray.eq(jsonlist.length-1).nextAll().each(function(){
                            var tabpanelid = $(this).attr("aria-controls");
                            $(this).remove();
                            $(tab).children(".tab-content").children("#"+tabpanelid).remove();
                        });
                    }
                }else{
                    layer.alert('标签页数量不能少于1个！', {
                            icon: 7,
                            area: ['400px', ''], // 宽高
                            closeBtn: 0
                        }
                    );
                    return false;
                }
                layer.close(index);
            }
        });
    }

});